@using STPC.DynamicForms.Web.RT.Helpers
@{
    var userModel = (STPC.DynamicForms.Web.RT.Models.LoginViewModel)ViewBag.userModel;
     
}

<!DOCTYPE html>
<html>
<head>
    <title>@ViewBag.Title</title>
    <link href="@Url.Content("~/Content/joinweb_style.css")" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/jquery-ui-1.8.21.custom.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/js/jsNotifications/ext/jboesch-Gritter/css/jquery.gritter.css")" />


    <script src="@Url.Content("~/Scripts/jquery-1.8.2.min.js")" type="text/javascript"></script>

    @*<script src="@Url.Content("~/Content/js/jsNotifications/ext/jquery-1.7.2.min.js")" type="text/javascript"></script>*@
    <script src="@Url.Content("~/Content/js/jsNotifications/ext/jboesch-Gritter/js/jquery.gritter.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Content/js/jsNotifications/jsNotifications.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Content/js/notifications-example.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.form.js")" type="text/javascript"></script>

    <script src="@Url.Content("~/Scripts/jquery.numeric.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/LiSimAbcGeneralJs.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery-ui-1.9.0.min.js")" type="text/javascript"></script>
        
    <script src="@Url.Content("~/Scripts/jquery.unobtrusive-ajax.js")" type="text/javascript"></script>
    <script src="@Url.Content("/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/Forms/Respond.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/Forms/TimeOut.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/Forms/FormPageActions.js")" type="text/javascript"></script>
    
    <script src="@Url.Content("~/Scripts/jquery.blockUI.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.toolTip.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/ui.dialogr.js")" type="text/javascript"></script>

    @*<link rel="stylesheet" id='camera-css'  media='all' type="text/css" href="@Url.Content("~/Content/camera.css")" />*@



    <link rel='stylesheet' id='camera-css'  href='@Url.Content("~/Content/camera.css")' type='text/css' media='all'>
    <style>
        .error {
            border: 1px solid rgba(215, 0, 0, 0.75);
            box-shadow: inset 0px 0px 2px 0px rgba(255, 0, 0, 0.75);
        }

        body {
            margin: 0;
            padding: 0;
        }

        a {
            color: #09f;
        }

            a:hover {
                text-decoration: none;
            }

        #back_to_camera {
            clear: both;
            display: block;
            height: 80px;
            line-height: 40px;
            padding: 20px;
        }

        .fluid_container {
            max-width: 1000px;
            width: 90%;
        }
    </style>
    @*<script src="@Url.Content("~/Scripts/jquery.min.js")" type="text/javascript"></script>*@
    @*<script src="@Url.Content("~/Scripts/jquery.mobile.customized.min.js")" type="text/javascript"></script>*@
    <script src="@Url.Content("~/Scripts/jquery.easing.1.3.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/camera.min.js")" type="text/javascript"></script>
    <!--scripts menu desplegable-->
    <script type="text/javascript">
        $(document).ready(function () { // Script del Navegador
            $("ul.subnavegador").hide();
            $("a.desplegable").toggle(
              function () {
                  $(this).parent().find("ul.subnavegador").slideDown('fast');
              },
              function () {
                  $(this).parent().find("ul.subnavegador").slideUp('fast');
              }
            );
        });
    </script>
    <!--menu desplegable-->
    @RenderSection("HeadAssets", required: false)

</head>
<body onbeforeunload="doUnload()" onmousedown="somefunction()" onunload="doUnload()">

    <div id="container">



        <!--@Html.ActionLink("Contestar preguntas de seguridad", "Answer_Question", "Account", null, new { @class = "NewLink" }) / @Html.ActionLink("Cambiar contraseña", "ChangePassword", "Account") / <a href="#">Ayuda</a> /@Html.ActionLink("Cerrar sesión", "Logoff", "Account")-->
        <header>
            <div id="header">
                <div id="izq">
                    <a href="http://lisim-abcuat.cloudapp.net:2352/Home/MenuAuth">
                        <img src="@Url.Content("~/Content/images/custom/ClientLogo.png")" width="231" height="64" border="0" /></a>
                </div>
                <div class="links1">
                    @Html.ActionLink("Contestar preguntas de seguridad", "Answer_Question", "Account", null, new { @class = "NewLink" }) / @Html.ActionLink("Cambiar contraseña", "ChangePassword", "Account") / <a href="#">Ayuda</a> /@Html.ActionLink("Cerrar sesión", "Logoff", "Account")

                </div>
                <div id="animacion1">
                    <h1 id="bienvenida"><span class="txtnaranja txtbold">Bienvenido</span> @Html.GetUsername(this.User.Identity.Name) <span class="txtazul txtbold">&Uacute;ltima fecha de ingreso:</span>@Html.GetLastLogin(this.User.Identity.Name)</h1>
                    <!--<div id="logmensajes1">
                        @if (Session["AdCampaign"] != null)
                        {
                            <div class="fluid_container">
                                <div class="camera_wrap camera_magenta_skin" id="camera_wrap_2">
                                    @foreach (STPC.DynamicForms.Web.RT.Services.Entities.AdCampaign item in (List<STPC.DynamicForms.Web.RT.Services.Entities.AdCampaign>)Session["AdCampaign"])
                                    {
                                        string imageName = item.Image;						
                                        <div data-thumb=@imageName data-src=@imageName>
                                            <div class="camera_caption fadeFromBottom">
                                                @item.Text <em></em>
                                            </div>
                                        </div>
                                    }

                                </div>
                            </div>
                        }
                    </div>
                    <!--log mensajes-->
                </div>
            </div>
        </header>
        <!--<div id="header-wrapper">-->

        <!-- .fluid_container -->

        <!--<div style="clear: both; display: block; height: 10px"></div>-->


        <!--</div>-->

        <div class="clear"></div>
        <div id="content-wrapper">
            <div id="content">
                <div id="left-column">
                    @{                            
                        //Html.RenderAction("FormsMenu", "Home");
                        Html.RenderAction("FormsMenuAuth", "Home", userModel);
                    }
                </div>
                <div id="right-column">
                    @RenderBody()
                </div>
                <div class="clear"></div>
                <div id="footer">
                    <!--<img src="@Url.Content("~/Content/images/logo_pata.gif")" width="38" height="50" alt="Join" /><br />
                    Copyright © @DateTime.Now.Year - LiSim SAS-->
                </div>
            </div>
        </div>
        <div id="bottom">
        </div>
        <div id="footer1">
            <img src="@Url.Content("~/Content/images/custom/ClientLogoBottom.png")" width="60" height="30" alt="Join" /><br />
            Copyright © @DateTime.Now.Year - Lilian Simbaqueba SAS<br />
            V. @typeof(STPC.DynamicForms.Web.RT.Controllers.AccountController).Assembly.GetName().Version.ToString(3)
        </div>

    </div>
    <div id="AnswerDialog" title="Preguntas de seguridad" style="display: none; width: 800px">
    </div>
    <div id="dvForm"></div>
</body>

@RenderSection("BottomAssets", required: false)
</html>
<script>
    $(document).ajaxComplete(function () {
        var sessionTimeoutWarning =
	'@System.Configuration.ConfigurationSettings.AppSettings["SessionWarning"].ToString()';
        @{
            STPC.DynamicForms.Web.Common.CustomMembershipProvider provider = (STPC.DynamicForms.Web.Common.CustomMembershipProvider)Membership.Provider;
            }
        var sessionTimeout = '@provider.GetTimeOut()';

        if (sessionTimeoutWarning != undefined && sessionTimeout != undefined)
            setWarningTimeOut(sessionTimeoutWarning, sessionTimeout)
    });

    var isClose = false;
    document.onkeydown = checkKeycode
    function checkKeycode(e) {
        var keycode;
        if (window.event)
            keycode = window.event.keyCode;
        else if (e)
            keycode = e.which;
        if (keycode == 116) {
            isClose = true;
        }
    }
    function somefunction() {

        isClose = true;
    }
    function doUnload() {
        if (!isClose) {
            $.getJSON("/Account/LogOff");
        }
        else
            isClose = false;
    }


    $(document).ready(function () {



        var objInstanceName = new jsNotifications({
            autoCloseTime: 5,
            showAlerts: true,
            title: 'Contraseña proxima a expirar'
        });

        //check the browser support
        if (objInstanceName.isAvailable()) {
            //show the bar to Chrome/Chromium users
            if (objInstanceName.getStatus() == 1) $('#divBottomBar').fadeIn(1200);
        }

        $.ajax({
            type: 'POST',
            url: '/Home/GetDaysToExpirePassword',
            dataType: 'json',
            success: function (nDias) {

                if (nDias != -1) {
                    objInstanceName.show('warning', 'Faltan ' + nDias + ' días para expirar la contraseña.', true);
                }
            },
            error: function (req, status, error) {
                alert("Error: " + error);
            }
        });
        try {

            if ("@ViewData["formid"]" != '' && "@ViewData["RequestId"]" != '') {
                blockScreen("Un momento por favor...");

                $.ajax({
                    type: "POST",
                    url: "/form/formpagerespondview/",
                    data: {
                        'formid': "@ViewData["formid"]",
                        'requestid': "@ViewData["RequestId"]"
                    },
                    dataType: "html",
                    success: function (evt) {

                        $("#right-column").append($("#dvForm"));
                        $('#dvForm').html(evt);
                        $('#tblParameters').empty()
                        $('#tblParametros2').empty()
                        $.unblockUI();

                    },
                    error: function (result) {

                        var urlSite = window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
                        location.href = urlSite
                        $.unblockUI();
                    }

                });
            }
        }
        catch (err) {
            alert(err);
        }

    });


    $(function () {

        $('#AnswerDialog').dialog({
            autoOpen: false,
            width: 650,
            resizable: false,
            modal: true,
            buttons: {
                "Validar": function () {
                    if (comprobarCamposRequired()) {
                        $("#AnswerSecurityForm").submit();
                    } else {

                        alert('Rellene todos los campos');

                    }

                },
                "Cancelar": function () {
                    $(this).dialog("close");
                }
            }
        });

        $(".NewLink").click(function () {
            linkObj = $(this);
            var dialogDiv = $('#AnswerDialog');
            var viewUrl = linkObj.attr('href');

            $.get(viewUrl, function (data) {
                if (data.Success != false) {
                    dialogDiv.html(data);
                    var $form = $("#AnswerSecurityForm");
                    $form.unbind();
                    $form.data("validator", null);
                    $.validator.unobtrusive.parse(document);
                    $form.validate($form.data("unobtrusiveValidation").options);
                    dialogDiv.dialog('open');
                }
                else
                    if (data.ErrorMessage != "SessionError")
                        alert(data.ErrorMessage)
                    else {
                        alert("Sessión cerrada o usuario no logeado");
                        var urlSite = window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
                        location.href = urlSite + "/Home/Menu"

                    }
            });
            return false;
        });
    });

    function comprobarCamposRequired() {
        var correcto = true;
        var campos = $('input[type="text"]');
        var select = $('select:required');


        $(campos).each(function () {
            if ($(this).val() == '') {
                correcto = false;
                $(this).addClass('error');

                $(this).live('keyup', function () {
                    if ($(this).val() != "") {
                        $(this).removeClass('error');
                    }
                    else {
                        $(this).addClass('error');
                    }
                });
            }
        });
        $(select).each(function () {
            if ($(this).val() == '') {
                correcto = false;
                $(this).addClass('error');
            }
        });
        return correcto;
    }

    function updateSuccessQuestions(data) {

        if (data.Success != false) {
            alert("Proceso finalizado con éxito")
            $('#AnswerDialog').dialog("close");
        }
        else
            if (data.ErrorMessage != "SessionError")
                alert(data.ErrorMessage)
            else {
                alert("Sessión cerrada o usuario no logeado");
                var urlSite = window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
                location.href = urlSite + "/Home/Menu"

            }
    }

    function updateSuccessChangePassword(data) {
        if (data.Success != false) {
            var urlSite = window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
            location.href = urlSite + "/account/LogOff"
        }
        else {
            alert(data.ErrorMessage)
        }
    }

    $(document).ajaxComplete(function () {
        var sessionTimeoutWarning =
	'@System.Configuration.ConfigurationSettings.AppSettings["SessionWarning"].ToString()';
        @{
            STPC.DynamicForms.Web.Common.CustomMembershipProvider provider = (STPC.DynamicForms.Web.Common.CustomMembershipProvider)Membership.Provider;
            }
         var sessionTimeout = '@provider.GetTimeOut()';

         if (sessionTimeoutWarning != undefined && sessionTimeout != undefined)
             setWarningTimeOut(sessionTimeoutWarning, sessionTimeout)
     });

</script>
